<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{frame/nousual}">
<head>

<!-- Basic Page Needs
    ================================================== -->
<title>GroupsSelect</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description"
	content="Instello - Sharing Photos platform HTML Template">

<!-- icons
    ================================================== -->
<link rel="stylesheet" href="/assets/css/icons.css">

<!-- Favicon -->
<link href="/assets/images/favicon.png" rel="icon" type="image/png">

<!-- CSS 
    ================================================== -->
<link rel="stylesheet" href="/assets/css/uikit.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/tailwind-dark.css">

<style>
.one {
	width: 30px;
	display: inline-block;
}

.two {
	
	padding-right: 8px;
}

.three {
	border: 1px solid #ccc;
	width: 15rem;
}

.truncate {
	margin: 0px;
}

.four {
	text-align: center;
}

.comm {
	width: 700px;
}

.comt {
	width: 300px;
	text-align: left;
}

</style>

</head>
<body>
	<!-- 그룹 상세내역 -->
	<div layout:fragment="content" align="center">
		<br> <br>
		<form id="frm" action="/groupsFeed" method="post">
			
			<div class="col-lg-8 two">
				<br>
				<div class="block flex items-center py-3 px-4 space-x-3">
					<br>
					<div th:each="meals : ${mealImg}" class="three">
						<img th:src="${meals.fileDir}" alt="" class="card-img-top">
						<div class="flex-1 min-w-0 relative text-gray-500 four">
							<span class="text-black dark:text-white">[[${meals.typeCode}]]  [[${meals.mealTime}]]</span>
							<p class="truncate text-black">[[${meals.mealAmount}]]</p>
							<p class="text-black font-semibold dark:text-white">[[${meals.subject}]]</p>
						</div>
					</div>
				</div>
				<br>

				<!-- 댓글 출력 -->
				<div class="-mt-1 space-y-1 comm" id="reply" th:data-sessionid="${session.userId}" th:data-userid="${mealImg[0].userId}" th:data-postdate="${#dates.format(mealImg[0].postDate, 'yyyyMMdd')}">
					
				</div>
				<br>
				<!-- 댓글 출력 끝 -->
				<div class="bg-gray-200 dark:bg-gray-700 rounded-full rounded-md relative">
					<input type="text" placeholder="댓글을 입력하세요."
						class="bg-transparent max-h-8 shadow-none" id="cmmtSubject">
					<div class="absolute bottom-0 flex h-full items-center right-0 right-3 text-xl space-x-2">
						<a href=""><button type="button" style="font-size: 10px;"
								onclick="cmmtInsert()">등록</button></a> 
						<input type="hidden" id="postNo">
					</div>
				</div>
			</div>
		</form>
		
		
	<script>
	
		let groupMember = $('#reply').data('userid');

// 		let postDate = new Date();
		let postDate = Number($('#reply').data('postdate'));
		
		console.log(postDate + "날짜")

// 		let year = postDate.getFullYear();
// 		let month = postDate.getMonth() + 1;
// 		let date = postDate.getDate();

// 		postDate = year + '' + month + '' + date;

		let sessionId = $('#reply').data('sessionid');

		
		console.log(groupMember + postDate)
		
		// 페이지 로딩과 동시에 작동
		$(document).ready(function (){
			
			commentList(groupMember, postDate);

		})
		
	    // ▶ 댓글, 대댓글 리스트 출력 ajax
	    function commentList(groupMember, postDate) {
			console.log("왔어?")
	        $.ajax({
	                url: "/GroupComment",
	                type: 'post',
	                data: {"groupMember" : groupMember, "postNo" : postDate}
	            })
	            .then(data => {
	                console.dir(data[0]);
	                
	                // 댓글창 비우기
	                $("#reply").empty()
	
					// 댓글이 없는 경우
					if(data.length == 0) {
						$("#reply").append(
							`<p style="color:gray; text-align:center;">댓글이 없습니다.</p>`
						)
					}
	
	                // 댓글창 채우기
	                $(data).each(function (index, item) {
	                    console.log(item.profileImgPath);
						
						// 조건에 따른 댓글 버튼 출력
						let commentBtn = '';
	                    if(sessionId != null) {
							if(item.userId == sessionId) {
								commentBtn = `<button type="button" style="float: right; font-size:12px;" onclick="cmmtDelete(${item.no})">삭제</button>&nbsp;
					                           <button type="button" style="float: right; font-size:12px;" onclick="updateBox('${item.subject}', ${item.cmmtGroup}, ${item.no})">수정</button>
					                           <button type="button" style="float: right; font-size:12px;" id="cmmtReply${item.no}" onclick="reply(${item.cmmtGroup}, ${item.no})">답글</button>`
							}else {
								commentBtn = `<button type="button" style="float: right; font-size:12px;" id="cmmtReply${item.no}" onclick="reply(${item.cmmtGroup}, ${item.no})">답글</button>`
							}
						}
	                    
	                    
	                    // 1) 댓글일때
	                    // 댓글 쓴 아이디가 세션의 아이디와 같다면 수정, 삭제 기능 / 다르다면 답글 기능
	                    if (item.cmmtClass == 0) {
	                        $("#reply").append(
	                            `<div class="flex flex-1 space-x-2" id="comment${item.no}">
	                    <a href="/myFeed/${item.userId}">   
	                    <img src="${item.profileImgPath}"
	                          class="rounded-full w-8 h-8"></a>
	                       <div class="flex-1" id="one${item.no}">
	                       <p id="p${item.no}"><b>${item.nickName}</b> 
	                       		<span style="font-size:10px;">${item.writeDate}</span>
	                       ${commentBtn}</p>
	                       <div id="subject${item.no}"><p>${item.subject}</p></div></div>
	                       <input type="hidden" id="cmmtClass${item.no}" value="0">
	                       <input type="hidden" id="cmmtOrder${item.no}" value="${item.cmmtOrder}">
	                    </div>`
	                        )
	                    }
	                    // 2) 대댓글일때
	                    // 대댓글 쓴 아이디가 세션의 아이디와 같다면 수정, 삭제 기능
	                    if (item.cmmtClass != 0) {
	                    	console.log(item)
	                        $("#reply").append(
	                            `<div class="flex flex-1 space-x-2" style="padding-left:25px;">
			                       <img src="${item.profileImgPath}"
			                          class="rounded-full w-8 h-8">
			                       <div class="flex-1" id="replyOne${item.no}"><p id="p${item.no}"><b>${item.nickName}</b> <span style="font-size:10px;">${item.writeDate}</span>
			                       ${item.userId == sessionId ? 
			                          `<button type="button" style="float: right; font-size:12px;" onclick="cmmtDelete(${item.no})">삭제</button>&nbsp;
			                          <button type="button" style="float: right; font-size:12px;" onclick="updateBox('${item.subject}', ${item.cmmtGroup}, ${item.no})">수정</button>` : ``}</p>
			                          <div id="subject${item.no}"><p>${item.subject}</p></div></div>
			                          <input type="hidden" id="cmmtClass${item.no}" value="1">
			                          <input type="hidden" id="cmmtOrder${item.no}" value="${item.cmmtOrder}">
	                    		 </div> `
	                        )
	                    }
	                });
	            })
	    };
	</script>
	</div>
</body>
</html>