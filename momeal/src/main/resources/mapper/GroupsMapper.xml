<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.doeat.community.mapper.GroupsMapper">


	<resultMap type="co.doeat.community.service.GroupsVO"
		id="groupsImg">
		<collection property="mealsImg" javaType="ArrayList"
			ofType="co.doeat.activity.service.MealVO" select="imgList"
			column="{userId=USER_ID, postDate=POST_DATE}" />
	</resultMap>


	<!-- 내가 속한 그룹 전체 멤버리스트 출력 -->
	<select id="groupsList" resultMap="groupsImg">
		SELECT U.USER_ID, 
		       U.USER_NAME,
		       #{postDate} as post_date,
		       U.NICK_NAME, 
		       U.PROFILE_IMG_PATH, 
		       GM.*, 
		       GL.*
		       
		FROM USERS U
		JOIN GROUP_MEMBER GM 
		  ON (U.USER_ID = GM.USER_ID)
		JOIN GROUP_LISTS GL 
		  ON (GM.NO = GL.NO)
	   WHERE GL.NO = #{no}
	</select>

	<select id="imgList"
		resultType="co.doeat.activity.service.MealVO">
		SELECT M.*
		FROM MEALS M
		WHERE TRUNC(post_date) = TO_DATE(#{postDate}, 'yyyyMMdd')
		AND M.USER_ID = #{userId}
		ORDER BY M.NO
	</select>

	<!-- 그룹 단건조회 -->
	<select id="groupsSelect" resultType="map">
		SELECT U.USER_ID,
		U.USER_NAME, U.NICK_NAME, U.PROFILE_IMG_PATH, M.*, GM.*, GL.*
		FROM
		USERS U JOIN MEALS M ON(U.USER_ID = M.USER_ID)
		JOIN GROUP_MEMBER GM ON
		(M.USER_ID = GM.USER_ID)
		JOIN GROUP_LISTS GL ON (GM.NO = GL.NO)
		WHERE
		TRUNC(post_date) = TO_DATE(#{postDate},'yyyyMMdd') AND M.USER_ID =
		#{userId}
	</select>
	
	<!-- 내가 참여중인 그룹 -->
	<select id="grpList" resultType="map">
		 SELECT U.USER_ID, 
		       U.USER_NAME,
		       U.NICK_NAME, 
		       GM.*, 
		       GL.*
		       
		FROM USERS U
		JOIN GROUP_MEMBER GM 
		  ON (U.USER_ID = GM.USER_ID)
		JOIN GROUP_LISTS GL 
		  ON (GM.NO = GL.NO)
		WHERE U.USER_ID = #{userId}   
	</select>

	<!-- 해당그룹 멤버리스트 조회 -->
	<select id="membList" resultType="map">
		SELECT U.NICK_NAME, U.PROFILE_IMG_PATH, GL.*, GM.*
	    FROM USERS U JOIN GROUP_MEMBER GM ON(U.USER_ID = GM.USER_ID)
	    JOIN GROUP_LISTS GL ON (GM.NO = GL.NO and GL.NO = #{no})
	</select>
</mapper>