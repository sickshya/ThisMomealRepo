<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="co.doeat.management.mapper.GroupPurchaseMapper">

	<!-- 전체 공구진행중 리스트 출력 -->
	<select id="getPurList" resultType="GroupPurchaseListVO">
		SELECT PL.NO
				,PL.NAME
				,PL.CO_NAME
				,PL.PRICE
				,PL.SUBJECT
				,PL.MIN_GD
				,PL.SPLY_GD
				,PL.GRP_START_DATE
				,PL.GRP_END_DATE
				,PL.THUMBNAIL_IMG
				,PL.THUMBNAIL_IMG_PATH
				,COUNT(PST.NO) AS ordCnt
		  FROM	GROUP_PURCHASE_LISTS PL
		  JOIN  GROUP_PURCHASE_SETTLEMENT PST ON PL.NO =	PST.NO
		  GROUP BY PL.NO
				,PL.NAME
				,PL.CO_NAME
				,PL.PRICE
				,PL.SUBJECT
				,PL.MIN_GD
				,PL.SPLY_GD
				,PL.GRP_START_DATE
				,PL.GRP_END_DATE
				,PL.THUMBNAIL_IMG
				,PL.THUMBNAIL_IMG_PATH
	</select>

	<!-- 현재 진행중인 공구리스트 출력 -->
	<select id="getPurchasingList" resultType="GroupPurchaseListVO">
		SELECT PL.NO
				,PL.NAME
				,PL.CO_NAME
				,PL.PRICE
				,PL.SUBJECT
				,PL.MIN_GD
				,PL.SPLY_GD
				,PL.GRP_START_DATE
				,PL.GRP_END_DATE
				,PL.THUMBNAIL_IMG
				,PL.THUMBNAIL_IMG_PATH
				,COUNT(PST.NO) AS ordCnt
			FROM GROUP_PURCHASE_LISTS PL
			JOIN GROUP_PURCHASE_SETTLEMENT PST ON PL.NO = PST.NO
		<![CDATA[
			WHERE TRUNC(grp_start_date) <= sysdate AND sysdate < grp_end_date
		]]>
			GROUP BY PL.NO
				,PL.NAME
				,PL.CO_NAME
				,PL.PRICE
				,PL.SUBJECT
				,PL.MIN_GD
				,PL.SPLY_GD
				,PL.GRP_START_DATE
				,PL.GRP_END_DATE
				,PL.THUMBNAIL_IMG
				,PL.THUMBNAIL_IMG_PATH
	</select>

	<!-- 단건조회 -->
	<select id="getPurOne" resultType="GroupPurchaseListVO">
		SELECT g.*, 
		       i.*, 
		       (SELECT COUNT(*) 
				  FROM group_purchase_settlement
				  WHERE LIST_NO = i.POST_NO) ord_cnt
		FROM
		GROUP_PURCHASE_LISTS g LEFT JOIN IMAGES i
		ON (g.NO = i.POST_NO)
		WHERE
		i.POST_NO = #{postNo} AND i.board_code='CT03'
		ORDER BY g.NO
	</select>

	<!-- 배송정보 입력 -->
	<insert id="payInsert" parameterType="GroupPurchaseSettlementVO">
		<selectKey keyProperty="no" resultType="int" order="BEFORE">
			SELECT	MAX(NO)+1
			FROM GROUP_PURCHASE_SETTLEMENT
		</selectKey>
		insert into GROUP_PURCHASE_SETTLEMENT
					(NO,
					USER_ID,
					DELIVERY_ADDR,
					PAYMENT_MTHD, 
					ZIPCODE, 
					TEL, 
					TOTAL_GD, 
					TOTAL_PRICE
					)
			values( #{no},
					#{userId}, 
					#{deliveryAddr},
					#{paymentMthd}, 
					#{zipcode},
					#{tel},
					#{totalGd}, 
					#{totalPrice}
					)
	</insert>

	<!-- 배송정보 조회 -->
	<select id="getOrderList"
		resultType="GroupPurchaseSettlementVO">
			SELECT g.*, s.*
			FROM GROUP_PURCHASE_LISTS g 
			JOIN GROUP_PURCHASE_SETTLEMENT s
			ON (g.NO = s.LIST_NO)
			WHERE g.NO = 4
			ORDER BY g.NO
	</select>

	

	<!-- +++++++++++++++++마이페이지+++++++++++++++++++++++++++++++ -->
	<!-- 마이페이지 - 공동구매내역 전체리스트 -->
	<select id="getPurchaseList"
		resultType="co.doeat.management.service.GroupPurchaseListVO">
		SELECT U.*, P.*,G.*
		FROM USERS U LEFT JOIN
		GROUP_PURCHASE_SETTLEMENT P ON (U.USER_ID = P.USER_ID)
		LEFT JOIN
		GROUP_PURCHASE_LISTS G ON (P.NO = G.NO)
		WHERE U.USER_ID = #{userId}
	</select>

	<!-- 마이페이지 - 공동구매내역 상세보기 -->
	<select id="purchaseSelect" resultType="map">
		SELECT U.*, P.*,G.*
		FROM
		USERS U LEFT JOIN
		GROUP_PURCHASE_SETTLEMENT P ON (U.USER_ID =
		P.USER_ID)
		LEFT JOIN
		GROUP_PURCHASE_LISTS G ON (P.NO = G.NO)
		WHERE
		U.USER_ID = #{userId} AND
		P.NO = #{no}
	</select>

	<!-- +++++++++++++++++관리자+++++++++++++++++++++++++++++++ -->
	<!-- 관리자 -공동구매 물품 리스트 -->
	<sql id="creiteria">
		<where>
			<if test="grpStartDate != null and grpStartDate != '' ">
				grp_start_date = #{grpStartDate}
			</if>
			<if test="grpEndDate != null and grpEndDate != '' ">
				AND grp_end_date = #{grpEndDate}
			</if>
		</where>
	</sql>

	<select id="getCountTotal"
		parameterType="co.doeat.management.service.GroupPurchaseListVO"
		resultType="int">
		SELECT COUNT(*)
		FROM GROUP_PURCHASE_LISTS
		<include refid="creiteria"></include>
	</select>

	<select id="getAdminGroupPurchaseList"
		parameterType="co.doeat.management.service.GroupPurchaseListVO"
		resultType="co.doeat.management.service.GroupPurchaseListVO">
		SELECT * FROM( SELECT rownum rn, a.*
		from(

		SELECT
		no,name,co_name,grp_start_date,grp_end_date,
		<![CDATA[
	        CASE WHEN grp_start_date <=trunc(current_date) 
      		  		AND grp_end_date <= trunc(current_date) THEN '완료'
	            WHEN TRUNC(grp_start_date) <= TRUNC(current_date) 
	            	And trunc(current_date) <= grp_end_date Then '진행중' 
	            Else '진행전' END as gpstatus
 		]]>
		FROM GROUP_PURCHASE_LISTS

		<include refid="creiteria"></include>
		order by no
		
		<![CDATA[
		)a where rownum <= #{last}) b where rn  >= #{first} 
		]]>
	</select>

	<!-- 등록 -->
	<insert id="adminGPInsert"
		parameterType="co.doeat.management.service.GroupPurchaseListVO">
		<selectKey keyProperty="no" resultType="int" order="BEFORE">
			SELECT
			MAX (NO)+1 FROM GROUP_PURCHASE_LISTS
		</selectKey>
		INSERT INTO GROUP_PURCHASE_LISTS(NO,
		NAME,
		CO_NAME,
		PRICE,
		SUBJECT,
		MIN_GD,
		SPLY_GD,
		GRP_START_DATE,
		GRP_END_DATE,
		THUMBNAIL_IMG,
		THUMBNAIL_IMG_PATH)
		VALUES(#{no},
		#{name},
		#{coName},
		#{price},
		#{subject},
		#{minGd},
		#{splyGd},
		#{grpStartDate},
		#{grpEndDate},
		#{thumbnailImg},
		#{thumbnailImgPath})
	</insert>

	<!-- 삭제 -->
	<delete id="adminGPDelete"
		parameterType="co.doeat.management.service.GroupPurchaseListVO">
		DELETE FROM GROUP_PURCHASE_LISTS WHERE NO= #{no}
	</delete>

	<!-- 수정 -->
	<update id="adminGPUpdate">
		UPDATE GROUP_PURCHASE_LISTS
		<set>
			<if test="name != null">name = #{name},</if>
			<if test="coName != null">co_Name = #{coName},</if>
			<if test="price != null">price = #{price},</if>
			<if test="subject != null">subject = #{subject},</if>
			<if test="minGd != null">min_gd = #{minGd},</if>
			<if test="splyGd != null">sply_gd = #{splyGd},</if>
			<if test="grpStartDate != null">grp_start_date = #{grpStartDate},</if>
			<if test="grpEndDate != null">grp_end_date = #{grpEndDate},</if>
			<if test="thumbnailImg != null">THUMBNAIL_IMG = #{thumbnailImg},</if>
			<if test="thumbnailImgPath != null">THUMBNAIL_IMG_PATH =#{thumbnailImgPath}</if>
		</set>
		WHERE NO = #{no}
	</update>

	<!-- 공동구매리스트 맵 -->
	<!-- <resultMap -->
	<!-- type="co.doeat.management.service.GroupPurchaseListVO" id="gpListMap"> -->
	<!-- <id property="no" column="no" /> -->
	<!-- <result property="no" column="no" /> -->
	<!-- <result property="name" column="name" /> -->
	<!-- <result property="coName" column="co_name" /> -->
	<!-- <result property="price" column="price" /> -->
	<!-- <result property="subject" column="subject" /> -->
	<!-- <result property="minGd" column="min_gd" /> -->
	<!-- <result property="splyGd" column="sply_gd" /> -->
	<!-- <result property="grpStartDate" column="grp_Start_Date" /> -->
	<!-- <result property="grpEndDate" column="grp_End_Date" /> -->
	<!-- <result property="thumbnailImgPath" column="thumbnail_Img_Path" /> -->
	<!-- <result property="thumbnailImgPath" column="thumbnail_Img" /> -->
	<!-- <collection property="imgPath" resultMap="imgMap"></collection> -->
	<!-- </resultMap> -->

	<!-- 공구 단건 이미지이름 맵 -->
	<!-- <resultMap type="co.doeat.common.service.ImageVO" id="imgMap"> -->
	<!-- <result property="postNo" column="post_No" /> -->
	<!-- <result property="boardCode" column="board_Code" /> -->
	<!-- <result property="atchPath" column="atch_Path" /> -->
	<!-- </resultMap> -->

	<!-- 관리자용 단건조회 (이미지다수, 글 하나) -->
	<select id="adminGPSelect" resultType="GroupPurchaseListVO">
		SELECT *
		FROM GROUP_PURCHASE_LISTS
		WHERE no = #{no}
	</select>
</mapper>